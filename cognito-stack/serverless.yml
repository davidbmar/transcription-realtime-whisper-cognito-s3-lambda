service: ${env:SERVICE_NAME, 'clouddrive-app'}

provider:
  name: aws
  runtime: nodejs18.x
  region: ${env:AWS_REGION, 'us-east-2'}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:GetObject
          Resource: "arn:aws:s3:::#{WebsiteBucket}/*"

        # S3 PERMISSIONS for listing the bucket
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource: !Sub "arn:aws:s3:::${WebsiteBucket}"

        # S3 permissions for download URL generation
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:GetObjectVersion
            - s3:HeadObject
          Resource: !Sub "arn:aws:s3:::${WebsiteBucket}/*"

        # S3 write permissions for memory storage
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:PutObjectAcl
          Resource: !Sub "arn:aws:s3:::${WebsiteBucket}/claude-memory/*"

        # S3 write permissions for user file uploads
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:PutObjectAcl
          Resource: !Sub "arn:aws:s3:::${WebsiteBucket}/users/*"

        # S3 delete permissions for user files
        - Effect: Allow
          Action:
            - s3:DeleteObject
            - s3:DeleteObjects
          Resource: !Sub "arn:aws:s3:::${WebsiteBucket}/users/*"

        # S3 copy permissions for rename operations
        - Effect: Allow
          Action:
            - s3:CopyObject
          Resource: !Sub "arn:aws:s3:::${WebsiteBucket}/users/*"

custom:
  s3Bucket: ${env:COGNITO_S3_BUCKET, '${self:service}-bucket'}

functions:
  # Test endpoint
  api:
    handler: api/handler.getData
    events:
      - http:
          path: data
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  # S3 File Manager Functions
  listS3Files:
    handler: api/s3.listObjects
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/s3/list
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  getS3DownloadUrl:
    handler: api/s3.getDownloadUrl
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/s3/download/{key+}
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  getS3UploadUrl:
    handler: api/s3.getUploadUrl
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/s3/upload
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  deleteS3Object:
    handler: api/s3.deleteObject
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/s3/delete/{key+}
          method: delete
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  renameS3Object:
    handler: api/s3.renameObject
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/s3/rename
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  moveS3Object:
    handler: api/s3.moveObject
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/s3/move
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  # Audio Recording Functions
  uploadAudioChunk:
    handler: api/audio.uploadChunk
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/audio/upload-chunk
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  updateAudioSessionMetadata:
    handler: api/audio.updateSessionMetadata
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/audio/session-metadata
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  listAudioSessions:
    handler: api/audio.listSessions
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/audio/sessions
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  getFailedAudioChunks:
    handler: api/audio.getFailedChunks
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/audio/failed-chunks
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  deleteAudioChunk:
    handler: api/audio.deleteChunk
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/audio/delete-chunk
          method: delete
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  # Claude Memory Storage Functions
  storeClaudeMemory:
    handler: api/memory.storeMemory
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/memory
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer

  storeClaudeMemoryPublic:
    handler: api/memory.storeMemoryPublic
    environment:
      S3_BUCKET_NAME: ${self:custom.s3Bucket}
    events:
      - http:
          path: api/memory/public
          method: post
          cors: true

resources:
  Resources:
    # API Gateway Authorizer
    ApiGatewayAuthorizer:
      Type: AWS::ApiGateway::Authorizer
      Properties:
        Name: cognito-authorizer
        IdentitySource: method.request.header.Authorization
        RestApiId:
          Ref: ApiGatewayRestApi
        Type: COGNITO_USER_POOLS
        ProviderARNs:
          - !GetAtt UserPool.Arn

    # S3 bucket for website hosting with public access
    WebsiteBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.s3Bucket}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders: ['*']
              AllowedMethods: [GET, HEAD, PUT]
              AllowedOrigins: ['*']
              MaxAge: 3000

    # Cognito user pool
    UserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-user-pool-${sls:stage}
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: true

    # Cognito user pool client
    UserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-app-client-${sls:stage}
        UserPoolId: !Ref UserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_SRP_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
        AllowedOAuthFlowsUserPoolClient: true
        AllowedOAuthFlows:
          - implicit
          - code
        AllowedOAuthScopes:
          - email
          - openid
          - profile
        CallbackURLs:
          - 'http://localhost:8080/callback.html'
        LogoutURLs:
          - 'http://localhost:8080/index.html'
        SupportedIdentityProviders:
          - COGNITO

    # Cognito identity pool
    IdentityPool:
      Type: AWS::Cognito::IdentityPool
      Properties:
        IdentityPoolName: ${self:service}-identity-pool-${sls:stage}
        AllowUnauthenticatedIdentities: false
        CognitoIdentityProviders:
          - ClientId: !Ref UserPoolClient
            ProviderName: !GetAtt UserPool.ProviderName

    # IAM roles for authenticated users
    AuthenticatedRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Federated: cognito-identity.amazonaws.com
              Action: sts:AssumeRoleWithWebIdentity
              Condition:
                StringEquals:
                  cognito-identity.amazonaws.com:aud: !Ref IdentityPool
                ForAnyValue:StringLike:
                  cognito-identity.amazonaws.com:amr: authenticated
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess

    # Note: Identity Pool roles are set via manual Lambda invocation in script 420
    # (Removed custom resource to avoid CloudFormation timeout issues)

    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Origins:
            - DomainName: !Sub "${WebsiteBucket}.s3.${AWS::Region}.amazonaws.com"
              Id: S3Origin
              S3OriginConfig:
                OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}"
          Enabled: true
          DefaultRootObject: index.html
          DefaultCacheBehavior:
            AllowedMethods:
              - GET
              - HEAD
            TargetOriginId: S3Origin
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
            ViewerProtocolPolicy: redirect-to-https
          CustomErrorResponses:
            - ErrorCode: 403
              ResponsePagePath: /index.html
              ResponseCode: 200
              ErrorCachingMinTTL: 10
            - ErrorCode: 404
              ResponsePagePath: /index.html
              ResponseCode: 200
              ErrorCachingMinTTL: 10
          ViewerCertificate:
            CloudFrontDefaultCertificate: true

    CloudFrontOriginAccessIdentity:
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: "Access identity for S3 bucket"

    # Update the bucket policy to grant CloudFront access
    WebsiteBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref WebsiteBucket
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
              Action: 's3:GetObject'
              Resource: !Join ['', ['arn:aws:s3:::', !Ref WebsiteBucket, '/*']]

  Outputs:
    WebsiteURL:
      Description: S3 Website URL
      Value: !GetAtt WebsiteBucket.WebsiteURL
    WebsiteBucketName:
      Description: Name of the S3 bucket for website hosting
      Value: !Ref WebsiteBucket
    ApiEndpoint:
      Description: URL of the API Gateway endpoint (base URL for all API routes)
      Value: !Sub "https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${sls:stage}"
    UserPoolId:
      Description: ID of the Cognito User Pool
      Value: !Ref UserPool
    UserPoolClientId:
      Description: ID of the Cognito User Pool Client
      Value: !Ref UserPoolClient
    IdentityPoolId:
      Description: ID of the Cognito Identity Pool
      Value: !Ref IdentityPool
    CloudFrontURL:
      Description: URL of the CloudFront distribution
      Value: !Sub "https://${CloudFrontDistribution.DomainName}"
